import pandas as pd
import json
from io import StringIO
from langchain.schema import Document
from services.ocr import extract_text_from_image
from services.llm_process import process_with_llm, process_image_with_llm
from core.vectorstore import vectorstore

def initialize_demo_data():
    """
    初始化 Demo 數據：提取圖片文字、使用 LLM 處理，並存入向量資料庫。
    """
    try:
        print("初始化 Demo 數據處理...")
        # 替換成你的 Demo 圖片路徑
        # image_path = "source/table.png"

        # OCR 提取文字
        # extracted_text = extract_text_from_image(image_path=image_path)
        # print(f"OCR 提取的文字：\n{extracted_text}")

        # 使用 LLM 處理提取的文字
        # structured_data = process_with_llm(extracted_text)
        # print("LLM 整理後的數據：")
        # print(structured_data)

        json_data = """
        {
            "臺北市": {
                "綠運輸 (%)": 60.7,
                "公共運具 (%)": 42.0,
                "非機動運具 (%)": 18.8,
                "步行 (%)": 15.3,
                "自行車 (含公共) (%)": 3.5,
                "私人機動運具 (%)": 39.3,
                "最常公共運具使用率 (%)": 51.7
            },
            "大安區": {
                "綠運輸 (%)": 72.9,
                "公共運具 (%)": 51.3,
                "非機動運具 (%)": 21.3,
                "步行 (%)": 17.7,
                "自行車 (含公共) (%)": 3.8,
                "私人機動運具 (%)": 27.1,
                "最常公共運具使用率 (%)": 66.5
            },
            "中正區": {
                "綠運輸 (%)": 72.4,
                "公共運具 (%)": 51.1,
                "非機動運具 (%)": 21.3,
                "步行 (%)": 17.7,
                "自行車 (含公共) (%)": 3.6,
                "私人機動運具 (%)": 27.6,
                "最常公共運具使用率 (%)": 66.2
            },
            "中山區": {
                "綠運輸 (%)": 67.0,
                "公共運具 (%)": 45.0,
                "非機動運具 (%)": 16.7,
                "步行 (%)": 17.0,
                "自行車 (含公共) (%)": 4.3,
                "私人機動運具 (%)": 33.0,
                "最常公共運具使用率 (%)": 55.0
            },
            "信義區": {
                "綠運輸 (%)": 65.5,
                "公共運具 (%)": 45.2,
                "非機動運具 (%)": 20.3,
                "步行 (%)": 13.6,
                "自行車 (含公共) (%)": 6.7,
                "私人機動運具 (%)": 34.5,
                "最常公共運具使用率 (%)": 52.5
            },
            "松山區": {
                "綠運輸 (%)": 60.0,
                "公共運具 (%)": 41.7,
                "非機動運具 (%)": 18.3,
                "步行 (%)": 12.1,
                "自行車 (含公共) (%)": 6.2,
                "私人機動運具 (%)": 40.0,
                "最常公共運具使用率 (%)": 48.4
            },
            "文山區": {
                "綠運輸 (%)": 57.8,
                "公共運具 (%)": 40.2,
                "非機動運具 (%)": 17.6,
                "步行 (%)": 12.7,
                "自行車 (含公共) (%)": 4.9,
                "私人機動運具 (%)": 42.2,
                "最常公共運具使用率 (%)": 46.7
            },
            "北投區": {
                "綠運輸 (%)": 56.6,
                "公共運具 (%)": 41.7,
                "非機動運具 (%)": 14.9,
                "步行 (%)": 11.1,
                "自行車 (含公共) (%)": 3.8,
                "私人機動運具 (%)": 43.4,
                "最常公共運具使用率 (%)": 48.5
            },
            "南港區": {
                "綠運輸 (%)": 55.9,
                "公共運具 (%)": 41.0,
                "非機動運具 (%)": 14.9,
                "步行 (%)": 12.2,
                "自行車 (含公共) (%)": 2.7,
                "私人機動運具 (%)": 44.1,
                "最常公共運具使用率 (%)": 48.1
            },
            "士林區": {
                "綠運輸 (%)": 54.1,
                "公共運具 (%)": 39.7,
                "非機動運具 (%)": 14.4,
                "步行 (%)": 12.3,
                "自行車 (含公共) (%)": 2.1,
                "私人機動運具 (%)": 45.9,
                "最常公共運具使用率 (%)": 47.3
            },
            "大同區": {
                "綠運輸 (%)": 52.5,
                "公共運具 (%)": 37.0,
                "非機動運具 (%)": 15.5,
                "步行 (%)": 12.2,
                "自行車 (含公共) (%)": 3.3,
                "私人機動運具 (%)": 47.5,
                "最常公共運具使用率 (%)": 48.4
            },
            "萬華區": {
                "綠運輸 (%)": 46.5,
                "公共運具 (%)": 32.3,
                "非機動運具 (%)": 14.2,
                "步行 (%)": 11.5,
                "自行車 (含公共) (%)": 2.7,
                "私人機動運具 (%)": 53.5,
                "最常公共運具使用率 (%)": 44.5
            },
            "內湖區": {
                "綠運輸 (%)": 53.6,
                "公共運具 (%)": 35.0,
                "非機動運具 (%)": 23.1,
                "步行 (%)": 17.9,
                "自行車 (含公共) (%)": 5.1,
                "私人機動運具 (%)": 46.4,
                "最常公共運具使用率 (%)": 48.1
            }
        }
        """

        metadata = {"source": "markdown_table", "description": "行政區通勤數據"}
        vectorstore.add_texts(texts=[json_data], metadatas=[metadata])
        print("Demo 數據處理完成！")
    except Exception as e:
        print(f"初始化 Demo 數據時出錯: {e}")
